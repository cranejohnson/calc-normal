<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">



<html>
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Normal Depth</title>

  <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="http://code.highcharts.com/modules/exporting.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>


  <script src="https://rawgithub.com/highslide-software/draggable-points/master/draggable-points.js"></script>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">

  <style>


    .input {
      padding:10px;
      width:200px;
    border:1px dashed gray;
    margin:5px;
    }

    .chart {
    width: 700px;
    float: left;
    height: 500px;
    margin: 0 1em 1em 0;
    }
    #leftCol {
    width: 240px;
    float:left;
    }
    #main {
    width: 960px;
    float:left;
    }

    #dataTable: {
    width:700px;
    float:left;
    }
   textarea#xsInput {
	width: 684px;
	border: 3px solid #cccccc;
	padding: 5px;
	font-family: Tahoma, sans-serif;
}



  </style>
<script>

Highcharts.theme = {
	colors: ['#058DC7', '#50B432', '#ED561B', '#DDDF00', '#24CBE5', '#64E572', '#FF9655', '#FFF263', '#6AF9C4'],
	chart: {
		backgroundColor: {
			linearGradient: { x1: 0, y1: 0, x2: 1, y2: 1 },
			stops: [
				[0, 'rgb(255, 255, 255)'],
				[1, 'rgb(240, 240, 255)']
			]
		},
		borderWidth: 2,
		plotBackgroundColor: 'rgba(255, 255, 255, .9)',
		plotShadow: true,
		plotBorderWidth: 1
	},
	title: {
		style: {
			color: '#000',
			font: 'bold 16px "Trebuchet MS", Verdana, sans-serif'
		}
	},
	subtitle: {
		style: {
			color: '#666666',
			font: 'bold 12px "Trebuchet MS", Verdana, sans-serif'
		}
	},
	xAxis: {
		gridLineWidth: 1,
		lineColor: '#000',
		tickColor: '#000',
		labels: {
			style: {
				color: '#000',
				font: '11px Trebuchet MS, Verdana, sans-serif'
			}
		},
		title: {
			style: {
				color: '#333',
				fontWeight: 'bold',
				fontSize: '12px',
				fontFamily: 'Trebuchet MS, Verdana, sans-serif'

			}
		}
	},
	yAxis: {
		minorTickInterval: 'auto',
		lineColor: '#000',
		lineWidth: 1,
		tickWidth: 1,
		tickColor: '#000',
		labels: {
			style: {
				color: '#000',
				font: '11px Trebuchet MS, Verdana, sans-serif'
			}
		},
		title: {
			style: {
				color: '#333',
				fontWeight: 'bold',
				fontSize: '12px',
				fontFamily: 'Trebuchet MS, Verdana, sans-serif'
			}
		}
	},
	legend: {
		itemStyle: {
			font: '9pt Trebuchet MS, Verdana, sans-serif',
			color: 'black'

		},
		itemHoverStyle: {
			color: '#039'
		},
		itemHiddenStyle: {
			color: 'gray'
		}
	},
	labels: {
		style: {
			color: '#99b'
		}
	},

	navigation: {
		buttonOptions: {
			theme: {
				stroke: '#CCCCCC'
			}
		}
	}
};

// Apply the theme
var highchartsOptions = Highcharts.setOptions(Highcharts.theme);



var  normalDepth = {
    lengthUnits : 'ft',
    wse : 8,
    depth : 4,
    flowArea: 0,
    XSData : [
        {x:0,y:28.77},
        {x:6.7,y:28.61},
        {x:13.47,y:25.25},
        {x:21.95,y:23.9},
        {x:31.19,y:23.69},
        {x:31.74,y:23.59},
        {x:42.2,y:19.54},
        {x:58.04,y:18.04},
        {x:86,y:17.45},
        {x:115.7,y:17.67},
        {x:139.77,y:16.98},
        {x:169.64,y:16.76},
        {x:187.41,y:14.62},
        {x:188.56,y:11.85},
        {x:199.34,y:10.7},
        {x:206.49,y:9.79},
        {x:219.48,y:8.49},
        {x:229.36,y:7.65},
        {x:239.39,y:7.44},
        {x:254.45,y:7.33},
        {x:269.64,y:8.15},
        {x:283.8,y:7.7},
        {x:300.43,y:6.46},
        {x:311.14,y:6.04},
        {x:320.12,y:7.92},
        {x:330.35,y:8.88},
        {x:339.18,y:8.77},
        {x:350.08,y:8.1},
        {x:359.61,y:8.29},
        {x:365.68,y:9.72},
        {x:370.56,y:14.04},
        {x:379.36,y:16.27},
        {x:384.52,y:25.42},
        {x:405.55,y:27.73}
    ],
    n: 0.035,
    slope : 0.002,
    q : 20000
    }



  $(function() {



   $( "#nslider" ).slider({
      min: 0.005,
      max: 0.15,
      step: 0.001,
      value: normalDepth.n,
      slide: function( event, ui ) {
          $( "#n" ).val( ui.value );
        normalDepth.n = $("#n").val();
      	updateChart();
      },
    stop: function( event, ui ) {
        normalDepth.n = $("#n").val();
      	updateChart();
      }
    });
    $( "#n" ).val( $( "#nslider" ).slider( "value" ) );

   $( "#sslider" ).slider({
      min: 0.00001,
      max: 0.01,
      step: 0.0001,
      value: normalDepth.slope,
      slide: function( event, ui ) {
          $( "#slope" ).val( ui.value );
        normalDepth.slope = $("#slope").val();
      	updateChart();
      },
    stop: function( event, ui ) {
        normalDepth.slope = $("#slope").val();
      	updateChart();
      }
    });
  $( "#slope" ).val( $( "#sslider" ).slider( "value" ) );

  $( "#qslider" ).slider({
      min: 100.0,
      max: 40000,
      step: 100.0,
      value: normalDepth.q,
      slide: function( event, ui ) {
          $( "#q" ).val( ui.value );
        normalDepth.q = parseFloat($("#q").val());
      	updateChart();
      },
    stop: function( event, ui ) {
        normalDepth.q = parseFloat($("#q").val());
      	updateChart();
      }
    });
    $( "#q" ).val( $( "#qslider" ).slider( "value" ) );

  $( "#wseslider" ).slider({
      min: 0,
      max: 35,
      step: 0.1,
      value: normalDepth.wse,
      slide: function( event, ui ) {
          $( "#wse" ).val( ui.value );
        normalDepth.wse = parseFloat($("#wse").val());
      	updateChart();
      },
    stop: function( event, ui ) {
        normalDepth.wse = parseFloat($("#wse").val());
      	updateChart();
      }
    });
    $( "#wse" ).val( $( "#wseslider" ).slider( "value" ) );

    $("#n").change(function() {
    normalDepth.n = parseFloat($("#n").val());
    updateChart();
  });

  $("#slope").change(function() {
    normalDepth.slope = parseFloat($("#slope").val());
    updateChart();
  });

  $("#q").change(function(){
    normalDepth.q = parseFloat($("#q").val());
    updateChart();
  });

  $("#wse").change(function(){
    normalDepth.wse = parseFloat($("#wse").val());
    updateChart();
  });

  });
  </script>

</head>
<body>
    <h3>Normal Depth Demonstration Tool</h3>
    <div id='main'>
    <div id='leftCol'>
      <div class = 'input'>Solve For:
        <select id = "solvetype">
          <option value="s">Slope</option>
          <option value="w" selected >Water Surface (normal depth)</option>
          <option value="n">Manning's n value</option>
          <option value="q">Discharge</option>
        </select>
      </div>
      <div class = 'input'>Slope:<input type="text" id="slope" size = "5" value = "0.001"> (<span class="lengthUnits"></span>/<span class="lengthUnits"></span>)<br><br><div id="sslider"></div></div>
      <div class = 'input'>WSE:<input type="text" id="wse" size = "5" value = ""> (<span class="lengthUnits"></span>)<br><br><div id='wseslider'></div></div>
      <div class = 'input'>Channel Manning n:<input type="text" id="n" size = "5" value="0.035"><br><br><div id="nslider"></div></div>
      <div class = 'input'>Flow:<input type="text" id="q" size = "10" value="400"> (<span class="lengthUnits"></span><sup>3</sup>/s)<br><br><div id='qslider'></div></div>
<!--      <input type="radio" name="units" value="m" checked onclick="setUnits();calcPage();"> Meters<br>-->
      <table class='testgrid'>
	    <tr><td>Flow Area:</td><td> <span id='area'></span></td><tr>
      	<tr><td>Wetted Perimeter:</td><td> <span id='wetP'></span></td><tr>
      	<tr><td>Max Depth:</td><td> <span id='depth'></span> (<span class="lengthUnits"></span>)</td><tr>
      	<tr><td>Average Velocity:</td><td> <span id='avgVel'></span> (<span class="lengthUnits"></span>/s)</td><tr>
      	<tr><td>Top Width:</td><td> <span id='topWidth'></span> (<span class="lengthUnits"></span>)</td><tr>
      	<tr><td>Iterations:</td><td> <span id='iterations'></span></td><tr>
      	<tr><td>Froude Number:</td><td> <span id='froude'></span></td><tr>
      </table>
      <input type="button" value="Reset Cross Section" onClick="window.location.href=window.location.href">
    </div>
      <div id='section' class='chart'></div>

       <div id='dataTable'>Copy and Paste Cross Section Values (station,elevation)<br>
       <button onclick="    updatePlotData('section',0,'xsInput'); updateChart();">Update Plot</button><br>
       <textarea id='xsInput' placeholder="Cross Section Data Goes Here."></textarea></div>
    </div>


</body>

<script>






$('#section').highcharts({
  credits: false,
  tooltip: {
  	pointFormat: "Elevation: {point.y:.2f} ft",
  	shared: true,
    positioner: function () {
    return { x: 80, y: 50 };
    }
  },
  plotOptions: {
    series: {
      //stickyTracking: false,
      threshold: null,
    }
  },

    chart: {
        ignoreHiddenSeries : false,
        events: {
            click: function(e) {
                //alert('clicked');
                // find the clicked values and the series
                var x = e.xAxis[0].value,
                newY = Math.round(e.yAxis[0].value/0.1)*0.1,
                series = this.series[0].data;
                var closest = series[0].x.value;
                var i = 0;
                $.each(series, function(){
                    if (closest == null || Math.abs(this.x - x) < Math.abs(closest - x)) {
                        closest = this.x;
                        i++;
                    }
                });
                this.series[0].data[i-1].update(y = newY);
                updateChart();
            }
        }
    },
    series:
    [{
        data: normalDepth.XSData,
        type : 'area',
        name : 'Ground',
        draggableY: true,
        draggableCallback : 'updateChart',
        dragPrecisionY: 0.01,
        zIndex : 10,
        animation : false,
        color : 'brown',
        fillOpacity: 1,
        marker : {
            fillColor: '#FFFFFF',
            enabled : true,
            radius: 3,
            lineColor: 'brown',
            lineWidth:1
        },
    },
    {
      data: wsePlotData(normalDepth.XSData,normalDepth.wse),
      type : 'area',
      name : 'Water',
      animation : false,
      tooltip: { enabled: false},
      zIndex: 1,
      color : 'rgb(0,0,204)',
      fillOpacity: 0.5,
      marker : { enabled : false},
      states: {
        hover: {
         enabled: false
        }
      }
    },
    {
      data: normalDepth.XSData,
      name : 'Original XS',
      type : 'line',
      zIndex : 20,
      animation : false,
      color : 'white',
      showInLegend: false,
      lineWidth: 1,
      dashStyle: 'longdash',
      enableMouseTracking: false,
      marker : {
      	enabled : false
        },
    }
    ],
  yAxis: {
    title: {
      enabled : true,
      text : 'Elevation ('+normalDepth.lengthUnits+')',
      style: {
        fontSize : '16px'
      }
    }
  },
  xAxis: {
    title: {
      enabled : true,
      text : 'Station ('+normalDepth.lengthUnits+')',
      style: {
        fontSize : '16px'
      }
    }
  },
  title: {
    text: 'Cross Section'
  }
});

updateChart();




///////////////////////////////////
//  Update XS Data
///////////////////////////////////

function updatePlotData(chartId,series,textId){
    var text = $.trim($("#"+textId).val());
    text = text.replace(/\r?\n/g, ',').replace(/\t/g,',');
    var data = text.split(/[ ,]+/);
    var x = true;
    var plotData = [];
    var num = 0;
    $.each(data,function(){

        if(x){
            plotData[num] = {};
            plotData[num].x = parseFloat(this);
        }
        if(!x) {
            plotData[num].y = parseFloat(this);
            num = num + 1;
        }
        x = !x;

    });
    var chart= $('#'+chartId).highcharts();
    chart.series[0].setData(plotData);
    chart.series[2].setData(plotData);
    normalDepth.XSData = plotData;

}


///////////////////////////////////
//  Update Text Area Data
///////////////////////////////////

function updateXSdata(chartId,series,textId){
    console.log(textId);
    var newData = new Array();
    var chart= $('#'+chartId).highcharts();
    var textData = '';
    var h = 0;
    series = chart.series[series].data;
    $.each(series, function(){
        textData = textData + this.x.toFixed(2) + ','+this.y.toFixed(2)+'\n';
        h = h+1;
  });
  $("#"+textId).val(textData);
  $("#"+textId).attr('rows', h);
}




///////////////////////////////////
//  Linear Interpolation
///////////////////////////////////

function lineInterpolate( point1, point2,XorY,value){
  var result = new Object();
  if(XorY == 'x'){
  result.y = value;
  ratio = (value-point1.y)/(point2.y-point1.y);
  result.x = Math.round(point1.x+ratio*(point2.x-point1.x));
  }
  if(XorY == 'y'){
  result.x = value;
  ratio = (value-point1.x)/(point2.x-point1.x);
  result.y = Math.round(point1.y+ratio*(point2.y-point1.y));
  }
  return result;
}

///////////////////////////////////
//  Array Lookup
///////////////////////////////////

function arrayLookup(XorY,value,array){
  var point = new Array();
  for (i = 0; i < array.length-1; i++){
    if(XorY == 'y'){
      if(array[i+1][1] <= value) {
        point = lineInterpolate(array[i],array[i+1],'y',value);
        break;
      }
    }
    if(XorY == 'x'){
      if(array[i+1][0] >= value){
        point = lineInterpolate(array[i],array[i+1],'x',value);
        break;
      }
    }
  }
  return point;
}




///////////////////////////////////
//  Develops the water surface plot data
///////////////////////////////////


function wsePlotData(XSdata,wse){
  var minX = 9999;
  var maxX = -9999;
  var data = new Array();
  for(i=1;i<=XSdata.length;i++){
    if(XSdata[i-1].x<minX) minX = XSdata[i-1].x;
    if(XSdata[i-1].x>maxX) maxX = XSdata[i-1].x;
    }
  data = [{
      x: minX,
      y:wse},
      {
      x:maxX,
      y:wse}];

  return data;
  }

///////////////////////////////////
//  Calculate area under the curve
///////////////////////////////////

function areaUnderCurve(XSdata){
  var area = 0;
  for(i=0;i<XSdata.length-1;i++){
    area += ((XSdata[i].y+XSdata[i+1].y)/2)*(XSdata[i+1].x-XSdata[i].x);
    }
  return area;

  }

///////////////////////////////////
//  Calculate Froude Number
///////////////////////////////////

function calcFroude(avgVel,avgDepth){
    g=32;
    froude = 0;
    froude = avgVel/(Math.sqrt(g*avgDepth));
  return froude;

  }


///////////////////////////////////
//  Calculate top width
///////////////////////////////////

 function calcWidth(series,wse){
  var trimmed = trimGround(series,wse);
  var width = 0;
  for(i=0;i<trimmed.length-1;i++){
    if(trimmed[i].y<wse || trimmed[i+1].y<wse){
      width += (trimmed[i+1].x-trimmed[i].x);
    }
  }
  return width;
}
///////////////////////////////////
//  Trim ground to max wse, return data
///////////////////////////////////

function trimGround(series,wse){
  var trimmed = Array();
  var yVal;
  for(i=0;i<series.length-1;i++){
    yVal = series[i].y;
    if(series[i].y>wse) yVal = wse;
    trimmed.push({
          x:series[i].x,
          y: yVal}
          );
    if((series[i].y>wse) && (series[i+1].y<wse)){
      point = lineInterpolate(series[i],series[i+1],'x',wse);
      trimmed.push(point);
      }
    if ((series[i].y<wse) && (series[i+1].y>wse)){
      point = lineInterpolate(series[i],series[i+1],'x',wse);
      trimmed.push(point);
      }

  }
  yVal = series[series.length-1].y;
  if(series[series.length-1].y>wse) yVal = wse;
  trimmed.push({
        x:series[series.length-1].x,
        y: yVal}
        );
  return trimmed;
}



///////////////////////////////////
//  Solve Mannings Equation
//      Q = (k/n) AR2/3S1/2
///////////////////////////////////

function mannings(slope,nValue,discharge,wse,xsData,solveFor){
  var k = 1.486;

  if(solveFor == 'q'){
    var wetP = wettedP(xsData,wse);
    var area =   areaUnderCurve(wsePlotData(xsData,wse))-areaUnderCurve(trimGround(xsData,wse));
    discharge = (k/nValue)*(area)*Math.pow(area/wetP,.666666)*Math.pow(slope,.5);
    return discharge;

  }
  if(solveFor == 's'){
    var wetP = wettedP(xsData,wse);
    var area =   areaUnderCurve(wsePlotData(xsData,wse))-areaUnderCurve(trimGround(xsData,wse));
    slope = Math.pow(discharge/((k/nValue)*(area)*Math.pow(area/wetP,.666666)),2);
    return slope;

  }
  if(solveFor == 'n'){
    var wetP = wettedP(xsData,wse);
    var area =   areaUnderCurve(wsePlotData(xsData,wse))-areaUnderCurve(trimGround(xsData,wse));
    nValue = ((k)*(area)*Math.pow(area/wetP,.666666)*Math.pow(slope,.5))/discharge;
    return nValue;
  }

  if(solveFor == 'wse'){
    var iterate = true;
    var i = 0;
    while(iterate){
      var wetP = wettedP(xsData,wse);
      var area = areaUnderCurve(wsePlotData(xsData,wse))-areaUnderCurve(trimGround(xsData,wse));
      var newDischarge = (k/nValue)*(area)*Math.pow(area/wetP,.666666)*Math.pow(slope,.5);
      var diff = Math.abs(newDischarge -  discharge);
      //if (diff > oldDiff) iterate = false;
      if(diff > discharge*.003){
        iterate = true;
      }
      else{
        iterate = false;
      }

      if(newDischarge > discharge){
        direction = -1;
       }
      else{
        direction = 1;
      }

      wse = wse + (direction*0.005);
      i++;
      if(i > 5000 || diff < (discharge*.0001)) iterate = false;
      var oldDiff = diff;

    }
    if(i > 50000){
		$("#iterations").html('max');
	}
	else{
	 	$("#iterations").html(i);
	}
    return wse;
  }
}

function calcWSE(series,depth){
  var min = 9999;
  var minpt = 0;
  for(i=0;i<series.length;i++){
    if(series[i].y<min) min = series[i].y;
    }

  return min+depth;
}

function calcDepth(series,wse){
  var min = 9999;
  var minpt = 0;
  for(i=0;i<series.length;i++){
    if(series[i].y<min) min = series[i].y;
    }
  return (wse-min);
}

function wettedP(series,wse){
  var trimmed = trimGround(series,wse);
  var wetP = 0;
  for(i=0;i<trimmed.length-1;i++){
    if(trimmed[i].y<wse || trimmed[i+1].y<wse){
      wetP += Math.sqrt(Math.pow((trimmed[i+1].x-trimmed[i].x),2)+Math.pow((Math.abs(trimmed[i].y-trimmed[i+1].y)),2));
    }
  }
  return wetP;
}

function calcVel(Q,A){
  return Q/A;
}





function solver(){
  if($("#solvetype").val() == 'q')
    normalDepth.q = mannings(normalDepth.slope,normalDepth.n,normalDepth.q,normalDepth.wse,normalDepth.XSData,'q');
  if($("#solvetype").val() == 'w')
    normalDepth.wse = mannings(normalDepth.slope,normalDepth.n,normalDepth.q,normalDepth.wse,normalDepth.XSData,'wse');
  if($("#solvetype").val() == 'n')
    normalDepth.n = mannings(normalDepth.slope,normalDepth.n,normalDepth.q,normalDepth.wse,normalDepth.XSData,'n');
  if($("#solvetype").val() == 's')
    normalDepth.slope = mannings(normalDepth.slope,normalDepth.n,normalDepth.q,normalDepth.wse,normalDepth.XSData,'s');

  normalDepth.flowArea = areaUnderCurve(wsePlotData(normalDepth.XSData,normalDepth.wse))-areaUnderCurve(trimGround(normalDepth.XSData,normalDepth.wse));
  if(normalDepth.flowArea < 0 ) normalDepth.flowArea = 0;
  normalDepth.wetP = wettedP(normalDepth.XSData,normalDepth.wse);

  normalDepth.topWidth = calcWidth(normalDepth.XSData,normalDepth.wse);

  normalDepth.avgVel = calcVel(normalDepth.q,normalDepth.flowArea).toFixed(2);
  normalDepth.froude = calcFroude(normalDepth.avgVel,(normalDepth.flowArea/normalDepth.topWidth));
 }

function loadFields(){
  var chart= $('#section').highcharts();
  $("#avgVel").html(normalDepth.avgVel);
  $(".lengthUnits").html(normalDepth.lengthUnits);
  $("#wetP").html(normalDepth.wetP.toFixed(1)+" ("+normalDepth.lengthUnits+")");
  $("#q").val(normalDepth.q.toFixed(0));
  $("#n").val(parseFloat(normalDepth.n).toFixed(3));
  $("#nslider").slider({value : $("#n").val()});
  $("#qslider").slider({value:$("#q").val()});
  $("#wseslider").slider({value:$("#wse").val()});
  $("#wseslider").slider({ min: chart.yAxis[0].getExtremes().dataMin});
  $("#wseslider").slider({ max: chart.yAxis[0].max});

  $("#slope").val(normalDepth.slope);
  $("#froude").html(normalDepth.froude.toFixed(2));
  $("#topWidth").html(normalDepth.topWidth);
  $("#sslider").slider({value : $("#slope").val()});
  $("#area").html(normalDepth.flowArea.toFixed(1)+" ("+normalDepth.lengthUnits+"<sup>2</sup>)");
  $("#wse").val(normalDepth.wse.toFixed(2));
  $("#depth").html(calcDepth(normalDepth.XSData,normalDepth.wse).toFixed(2));
}




function updateChart(){
    updateXSdata('section',0,'xsInput');
    solver();
    var chart= $('#section').highcharts();
    chart.series[0].setData(normalDepth.XSData);
    chart.series[1].setData(wsePlotData(normalDepth.XSData,normalDepth.wse));
    var yDataMin = chart.yAxis[0].getExtremes().dataMin;
    chart.series[0].update(chart.series[0].options);
    chart.series[1].update(chart.series[1].options);
    chart.yAxis[0].setExtremes(yDataMin-5,null);
    loadFields();


}


  </script>
